<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="catv1.Views.ScanPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:catv1.Converters"
    xmlns:vm="clr-namespace:catv1.ViewModels"
    xmlns:zxing="clr-namespace:ZXing.Net.Maui.Controls;assembly=ZXing.Net.Maui.Controls"
    Title="Scan ID"
    BackgroundColor="{StaticResource Background}">

    <ContentPage.Resources>
        <converters:StatusColorConverter x:Key="StatusColorConverter" />
        <converters:StatusConverter x:Key="StatusConverter" />
    </ContentPage.Resources>

    <Grid>
        <!--  Background Overlay for consistency (optional since camera might cover it)  -->
        <Image
            Aspect="AspectFill"
            Opacity="0.1"
            Source="Resources/Images/lecture_room.png" />

        <!--  SETUP VIEW  -->
        <Grid
            Padding="30"
            IsVisible="{Binding IsSetupVisible}"
            RowDefinitions="Auto, *, Auto">

            <!--  Header  -->
            <VerticalStackLayout Spacing="8">
                <Label Style="{StaticResource LabelHeader}" Text="New Session" />
                <Label
                    Style="{StaticResource LabelCaption}"
                    Text="Select class details to begin scanning."
                    TextColor="{StaticResource Gray400}" />
            </VerticalStackLayout>

            <!--  Form  -->
            <VerticalStackLayout
                Grid.Row="1"
                Spacing="32"
                VerticalOptions="Center">

                <!--  Course Selection  -->
                <VerticalStackLayout Spacing="10">
                    <Label
                        FontAttributes="Bold"
                        FontSize="12"
                        Text="COURSE"
                        TextColor="{StaticResource Secondary}" />
                    <Border
                        BackgroundColor="{StaticResource Surface}"
                        HeightRequest="60"
                        Stroke="{StaticResource GlassBorder}"
                        StrokeShape="RoundRectangle 16">
                        <Grid Padding="16,0" ColumnDefinitions="*, Auto">
                            <Entry
                                Placeholder="Class Name"
                                Text="{Binding SelectedCourse}"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                FontSize="18"
                                Text="â–¼"
                                TextColor="{StaticResource Gray400}"
                                VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>

                <!--  Date Selection  -->
                <VerticalStackLayout Spacing="10">
                    <Label
                        FontAttributes="Bold"
                        FontSize="12"
                        Text="DATE"
                        TextColor="{StaticResource Secondary}" />
                    <Border
                        BackgroundColor="{StaticResource Surface}"
                        HeightRequest="60"
                        Stroke="{StaticResource GlassBorder}"
                        StrokeShape="RoundRectangle 16">
                        <Grid Padding="16,0" ColumnDefinitions="Auto, *">
                            <Label
                                FontSize="20"
                                Text="ðŸ“…"
                                VerticalOptions="Center" />
                            <DatePicker
                                Grid.Column="1"
                                Date="{Binding SelectedDate}"
                                Format="ddd, MMM dd yyyy"
                                VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>

            </VerticalStackLayout>

            <!--  Action  -->
            <Button
                Grid.Row="2"
                Command="{Binding StartSessionCommand}"
                HeightRequest="56"
                Text="START SCANNING" />
        </Grid>


        <!--  SCANNING VIEW  -->
        <Grid IsVisible="{Binding IsSessionActive}" RowDefinitions="Auto, Auto, *">

            <!--  Top Bar  -->
            <Grid
                Padding="20"
                BackgroundColor="{StaticResource Surface}"
                ColumnDefinitions="Auto, *, Auto">
                <Border
                    BackgroundColor="{StaticResource GlassSelection}"
                    HeightRequest="40"
                    Stroke="{StaticResource GlassBorder}"
                    StrokeShape="RoundRectangle 20"
                    WidthRequest="40">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding BackCommand}" />
                    </Border.GestureRecognizers>
                    <Label
                        FontSize="18"
                        HorizontalOptions="Center"
                        Text="â¬…"
                        TextColor="White"
                        VerticalOptions="Center" />
                </Border>

                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                    <Label
                        FontSize="16"
                        HorizontalOptions="Center"
                        Style="{StaticResource LabelHeader}"
                        Text="{Binding SelectedCourse}" />
                    <Label
                        HorizontalOptions="Center"
                        Style="{StaticResource LabelCaption}"
                        Text="{Binding DateDisplay}" />
                </VerticalStackLayout>

                <Label
                    Grid.Column="2"
                    FontSize="24"
                    HorizontalOptions="Center"
                    Text="âš™"
                    TextColor="{StaticResource Gray400}"
                    VerticalOptions="Center" />
            </Grid>

            <!--  Camera & Stats Section  -->
            <ScrollView Grid.Row="1">
                <VerticalStackLayout Padding="20" Spacing="24">

                    <!--  Camera Frame  -->
                    <Border
                        HeightRequest="250"
                        Stroke="{StaticResource Info}"
                        StrokeShape="RoundRectangle 24"
                        StrokeThickness="1.5">
                        <Grid>
                            <zxing:CameraBarcodeReaderView
                                x:Name="cameraBarcodeReaderView"
                                BarcodesDetected="cameraBarcodeReaderView_BarcodesDetected"
                                IsDetecting="{Binding IsSessionActive}"
                                IsTorchOn="False" />

                            <!--  Overlay Brackets  -->
                            <Border
                                Margin="40"
                                BackgroundColor="Transparent"
                                HeightRequest="150"
                                Stroke="{StaticResource Info}"
                                StrokeShape="RoundRectangle 12"
                                StrokeThickness="4"
                                WidthRequest="200" />

                            <Border
                                Margin="0,0,0,20"
                                Padding="16,8"
                                BackgroundColor="#CC1E293B"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource GlassBorder}"
                                StrokeShape="RoundRectangle 20"
                                VerticalOptions="End">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="12"
                                    Text="SCANNING ACTIVE"
                                    TextColor="{StaticResource Info}" />
                            </Border>
                        </Grid>
                    </Border>

                    <!--  Feedback Toast  -->
                    <Border
                        Padding="16"
                        BackgroundColor="{StaticResource Surface}"
                        IsVisible="{Binding ShowFeedback}"
                        Stroke="{StaticResource Success}"
                        StrokeShape="RoundRectangle 16"
                        StrokeThickness="1">
                        <Grid ColumnDefinitions="Auto, *, Auto">
                            <Label
                                FontSize="20"
                                Text="âœ”"
                                TextColor="{StaticResource Success}"
                                VerticalOptions="Center" />
                            <VerticalStackLayout Grid.Column="1" Margin="12,0">
                                <Label
                                    FontAttributes="Bold"
                                    Style="{StaticResource LabelCaption}"
                                    Text="ATTENDANCE LOGGED"
                                    TextColor="{StaticResource Success}" />
                                <Label
                                    FontSize="14"
                                    Style="{StaticResource LabelHeader}"
                                    Text="{Binding LastScannedStudent.Name, StringFormat='{0} marked Present'}" />
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="2"
                                BackgroundColor="{StaticResource GlassSelection}"
                                Command="{Binding UndoScanCommand}"
                                CornerRadius="16"
                                FontSize="12"
                                HeightRequest="32"
                                Text="Undo"
                                TextColor="White" />
                        </Grid>
                    </Border>

                    <!--  Stats Cards  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                        <!--  Present  -->
                        <Border Style="{StaticResource StatCard}">
                            <VerticalStackLayout Spacing="8">
                                <Label Style="{StaticResource LabelCaption}" Text="PRESENT" />
                                <HorizontalStackLayout Spacing="4">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="28"
                                        Text="{Binding PresentCount}"
                                        TextColor="{StaticResource Success}" />
                                    <Label
                                        Style="{StaticResource LabelCaption}"
                                        Text="{Binding TotalCount, StringFormat='/ {0}'}"
                                        VerticalOptions="End" />
                                </HorizontalStackLayout>
                                <ProgressBar Progress="{Binding PresentProgress}" ProgressColor="{StaticResource Success}" />
                            </VerticalStackLayout>
                        </Border>

                        <!--  Absent  -->
                        <Border Grid.Column="1" Style="{StaticResource StatCard}">
                            <VerticalStackLayout Spacing="8">
                                <Label Style="{StaticResource LabelCaption}" Text="ABSENT" />
                                <HorizontalStackLayout Spacing="4">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="28"
                                        Text="{Binding AbsentCount}"
                                        TextColor="{StaticResource Error}" />
                                    <Label
                                        Style="{StaticResource LabelCaption}"
                                        Text="{Binding TotalCount, StringFormat='/ {0}'}"
                                        VerticalOptions="End" />
                                </HorizontalStackLayout>
                                <ProgressBar Progress="{Binding AbsentProgress}" ProgressColor="{StaticResource Error}" />
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <Label
                        HorizontalOptions="Center"
                        Style="{StaticResource LabelCaption}"
                        Text="Scan history and manual override below" />

                </VerticalStackLayout>
            </ScrollView>

            <!--  Roster List  -->
            <Grid
                Grid.Row="2"
                BackgroundColor="{StaticResource Background}"
                RowDefinitions="Auto, *">
                <Border
                    Padding="16"
                    BackgroundColor="{StaticResource Surface}"
                    Stroke="{StaticResource GlassBorder}"
                    StrokeThickness="0,1,0,1">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label
                            FontAttributes="Bold"
                            Style="{StaticResource LabelCaption}"
                            Text="CLASS ROSTER"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Column="1"
                            FontAttributes="Bold"
                            FontSize="12"
                            Text="ðŸ“¶ FILTERS"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <CollectionView Grid.Row="1" ItemsSource="{Binding Roster}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid
                                Padding="20,12"
                                BackgroundColor="{StaticResource Background}"
                                ColumnDefinitions="Auto, *, Auto">
                                <!--  Initials Avatar  -->
                                <Border
                                    BackgroundColor="{StaticResource Surface}"
                                    HeightRequest="44"
                                    Stroke="{StaticResource GlassBorder}"
                                    StrokeShape="RoundRectangle 22"
                                    WidthRequest="44">
                                    <Label
                                        FontAttributes="Bold"
                                        HorizontalOptions="Center"
                                        Text="{Binding Initials}"
                                        TextColor="{StaticResource Primary}"
                                        VerticalOptions="Center" />
                                </Border>

                                <VerticalStackLayout
                                    Grid.Column="1"
                                    Margin="16,0"
                                    VerticalOptions="Center">
                                    <Label
                                        FontSize="14"
                                        Style="{StaticResource LabelHeader}"
                                        Text="{Binding Name}" />
                                    <Label Style="{StaticResource LabelCaption}" Text="{Binding Id}" />
                                </VerticalStackLayout>

                                <!--  Status Button  -->
                                <Button
                                    Grid.Column="2"
                                    Padding="12,0"
                                    BackgroundColor="{Binding IsPresent, Converter={StaticResource StatusConverter}, ConverterParameter='Color'}"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ScanViewModel}}, Path=MarkStudentCommand}"
                                    CommandParameter="{Binding .}"
                                    CornerRadius="16"
                                    FontAttributes="Bold"
                                    FontSize="11"
                                    HeightRequest="32"
                                    Text="{Binding IsPresent, Converter={StaticResource StatusConverter}, ConverterParameter='Text'}"
                                    TextColor="White" />
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!--  Floating Finish Button  -->
                <Button
                    Grid.Row="1"
                    Margin="24"
                    BackgroundColor="{StaticResource Primary}"
                    Command="{Binding FinishSessionCommand}"
                    CornerRadius="28"
                    HeightRequest="56"
                    HorizontalOptions="Center"
                    Text="âœ“ FINISH SESSION"
                    VerticalOptions="End"
                    WidthRequest="220" />
            </Grid>
        </Grid>

    </Grid>
</ContentPage>
